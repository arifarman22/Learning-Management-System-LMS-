// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

enum Role {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  STUDENT
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  avatar        String?
  role          Role      @default(STUDENT)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  
  // Soft delete
  deletedAt     DateTime?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  coursesCreated      Course[]            @relation("InstructorCourses")
  enrollments         Enrollment[]
  lessonProgress      LessonProgress[]
  assessmentAttempts  AssessmentAttempt[]
  payments            Payment[]
  certificates        Certificate[]
  
  // Analytics cache
  studentAnalytics    StudentAnalytics?
  instructorAnalytics InstructorAnalytics?
  
  // Auth tokens
  refreshTokens       RefreshToken[]

  @@index([email])
  @@index([role, isActive])
  @@index([deletedAt])
  @@map("users")
}

model RefreshToken {
  id          String    @id @default(cuid())
  token       String    @unique
  userId      String
  
  // Security
  isRevoked   Boolean   @default(false)
  expiresAt   DateTime
  
  // Device tracking
  userAgent   String?
  ipAddress   String?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// COURSE STRUCTURE
// ============================================================================

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  parentId    String?
  
  // Soft delete
  deletedAt   DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  courses     Course[]

  @@index([slug])
  @@index([parentId])
  @@index([deletedAt])
  @@map("categories")
}

model Course {
  id                String        @id @default(cuid())
  title             String
  slug              String        @unique
  description       String
  thumbnail         String?
  previewVideo      String?
  
  // Instructor
  instructorId      String
  
  // Categorization
  categoryId        String
  
  // Metadata
  status            CourseStatus  @default(DRAFT)
  level             CourseLevel   @default(ALL_LEVELS)
  language          String        @default("en")
  
  // Pricing
  price             Decimal       @default(0) @db.Decimal(10, 2)
  currency          String        @default("USD")
  discountPrice     Decimal?      @db.Decimal(10, 2)
  
  // Course settings
  maxStudents       Int?
  duration          Int?          // in minutes
  hasAssessments    Boolean       @default(false)
  hasCertificate    Boolean       @default(false)
  passingScore      Int           @default(70)
  
  // Lifecycle
  publishedAt       DateTime?
  archivedAt        DateTime?
  
  // Soft delete
  deletedAt         DateTime?
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  instructor        User          @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  category          Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  modules           Module[]
  enrollments       Enrollment[]
  payments          Payment[]
  prerequisites     CoursePrerequisite[] @relation("Course")
  requiredBy        CoursePrerequisite[] @relation("Prerequisite")
  
  // Analytics cache
  analytics         CourseAnalytics?

  @@index([instructorId, status])
  @@index([categoryId, status])
  @@index([status, publishedAt])
  @@index([slug])
  @@index([deletedAt])
  @@map("courses")
}

model CoursePrerequisite {
  id               String   @id @default(cuid())
  courseId         String
  prerequisiteId   String
  
  createdAt        DateTime @default(now())

  course           Course   @relation("Course", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisite     Course   @relation("Prerequisite", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([courseId, prerequisiteId])
  @@index([courseId])
  @@index([prerequisiteId])
  @@map("course_prerequisites")
}

model Module {
  id          String    @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int
  duration    Int?      // in minutes
  
  // Soft delete
  deletedAt   DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@unique([courseId, order])
  @@index([courseId, order])
  @@index([deletedAt])
  @@map("modules")
}

enum LessonType {
  VIDEO
  READING
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
}

model Lesson {
  id              String    @id @default(cuid())
  moduleId        String
  title           String
  description     String?
  type            LessonType
  order           Int
  
  // Content
  content         String?   // Text content or HTML
  videoUrl        String?
  videoDuration   Int?      // in seconds
  attachments     Json?     // Array of file URLs
  
  // Settings
  isFree          Boolean   @default(false)
  isRequired      Boolean   @default(true)
  estimatedTime   Int?      // in minutes
  
  // Soft delete
  deletedAt       DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  module          Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  assessments     Assessment[]
  progress        LessonProgress[]

  @@unique([moduleId, order])
  @@index([moduleId, order])
  @@index([type])
  @@index([deletedAt])
  @@map("lessons")
}

model Assessment {
  id              String    @id @default(cuid())
  lessonId        String
  title           String
  description     String?
  type            String    @default("QUIZ") // QUIZ, ASSIGNMENT, EXAM
  
  // Settings
  passingScore    Int       @default(70)
  maxAttempts     Int?
  timeLimit       Int?      // in minutes
  questions       Json      // Array of question objects
  
  // Soft delete
  deletedAt       DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts        AssessmentAttempt[]

  @@index([lessonId])
  @@index([deletedAt])
  @@map("assessments")
}

// ============================================================================
// ENROLLMENT & PROGRESS TRACKING
// ============================================================================

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  DROPPED
  SUSPENDED
}

model Enrollment {
  id              String            @id @default(cuid())
  studentId       String
  courseId        String
  
  // Status
  status          EnrollmentStatus  @default(ACTIVE)
  progress        Decimal           @default(0) @db.Decimal(5, 2) // 0-100
  
  // Lifecycle
  enrolledAt      DateTime          @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  expiresAt       DateTime?
  lastAccessedAt  DateTime?
  
  // Soft delete
  deletedAt       DateTime?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  student         User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress  LessonProgress[]
  assessmentAttempts AssessmentAttempt[]
  certificate     Certificate?
  payment         Payment?

  @@unique([studentId, courseId, deletedAt])
  @@index([studentId, status])
  @@index([courseId, status])
  @@index([status, completedAt])
  @@index([deletedAt])
  @@map("enrollments")
}

enum LessonProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model LessonProgress {
  id              String              @id @default(cuid())
  enrollmentId    String
  lessonId        String
  studentId       String
  
  // Progress
  status          LessonProgressStatus @default(NOT_STARTED)
  progressPercent Decimal             @default(0) @db.Decimal(5, 2)
  timeSpent       Int                 @default(0) // in seconds
  
  // Lifecycle
  startedAt       DateTime?
  completedAt     DateTime?
  lastAccessedAt  DateTime?
  
  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  enrollment      Enrollment          @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson          Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student         User                @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId, status])
  @@index([lessonId, status])
  @@index([studentId, completedAt])
  @@map("lesson_progress")
}

model AssessmentAttempt {
  id              String    @id @default(cuid())
  enrollmentId    String
  assessmentId    String
  studentId       String
  
  // Attempt details
  attemptNumber   Int
  answers         Json      // Student's answers
  score           Decimal   @db.Decimal(5, 2)
  passed          Boolean
  
  // Timing
  startedAt       DateTime
  submittedAt     DateTime?
  timeSpent       Int?      // in seconds
  
  // Timestamps
  createdAt       DateTime  @default(now())

  // Relations
  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student         User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, assessmentId, attemptNumber])
  @@index([enrollmentId, passed])
  @@index([assessmentId, passed])
  @@index([studentId, submittedAt])
  @@map("assessment_attempts")
}

// ============================================================================
// PAYMENTS & REVENUE
// ============================================================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
  OTHER
}

model Payment {
  id                String        @id @default(cuid())
  enrollmentId      String        @unique
  studentId         String
  courseId          String
  
  // Payment details
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("USD")
  status            PaymentStatus @default(PENDING)
  method            PaymentMethod
  
  // External references
  transactionId     String?       @unique
  paymentGateway    String?       // stripe, paypal, etc.
  gatewayResponse   Json?
  
  // Refund
  refundedAmount    Decimal?      @db.Decimal(10, 2)
  refundedAt        DateTime?
  refundReason      String?
  
  // Timestamps
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  enrollment        Enrollment    @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student           User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course            Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([studentId, status])
  @@index([status, paidAt])
  @@index([transactionId])
  @@index([createdAt])
  @@map("payments")
}

// ============================================================================
// CERTIFICATES
// ============================================================================

model Certificate {
  id              String    @id @default(cuid())
  enrollmentId    String    @unique
  studentId       String
  courseId        String
  
  // Certificate details
  certificateNumber String  @unique
  issueDate       DateTime  @default(now())
  expiryDate      DateTime?
  
  // Content
  certificateUrl  String?
  verificationUrl String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student         User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([certificateNumber])
  @@index([issueDate])
  @@map("certificates")
}

// ============================================================================
// ANALYTICS AGGREGATION TABLES
// ============================================================================

model CourseAnalytics {
  id                    String   @id @default(cuid())
  courseId              String   @unique
  
  // Enrollment metrics
  totalEnrollments      Int      @default(0)
  activeEnrollments     Int      @default(0)
  completedEnrollments  Int      @default(0)
  droppedEnrollments    Int      @default(0)
  
  // Progress metrics
  avgProgress           Decimal  @default(0) @db.Decimal(5, 2)
  avgCompletionDays     Decimal? @db.Decimal(8, 2)
  
  // Engagement metrics
  totalTimeSpent        BigInt   @default(0) // in seconds
  avgTimeSpent          Int      @default(0) // in seconds
  
  // Assessment metrics
  avgAssessmentScore    Decimal? @db.Decimal(5, 2)
  assessmentPassRate    Decimal? @db.Decimal(5, 2)
  
  // Revenue metrics
  totalRevenue          Decimal  @default(0) @db.Decimal(12, 2)
  
  // Last update
  lastUpdatedAt         DateTime @updatedAt
  createdAt             DateTime @default(now())

  // Relations
  course                Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@map("course_analytics")
}

model StudentAnalytics {
  id                    String   @id @default(cuid())
  studentId             String   @unique
  
  // Enrollment metrics
  totalCoursesEnrolled  Int      @default(0)
  activeEnrollments     Int      @default(0)
  completedCourses      Int      @default(0)
  
  // Progress metrics
  avgProgress           Decimal  @default(0) @db.Decimal(5, 2)
  
  // Engagement metrics
  totalTimeSpent        BigInt   @default(0) // in seconds
  totalLessonsCompleted Int      @default(0)
  
  // Assessment metrics
  avgScore              Decimal? @db.Decimal(5, 2)
  totalAssessmentsTaken Int      @default(0)
  
  // Activity
  lastActiveAt          DateTime?
  
  // Last update
  lastUpdatedAt         DateTime @updatedAt
  createdAt             DateTime @default(now())

  // Relations
  student               User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_analytics")
}

model InstructorAnalytics {
  id                    String   @id @default(cuid())
  instructorId          String   @unique
  
  // Course metrics
  totalCourses          Int      @default(0)
  publishedCourses      Int      @default(0)
  draftCourses          Int      @default(0)
  
  // Student metrics
  totalStudents         Int      @default(0)
  activeStudents        Int      @default(0)
  
  // Revenue metrics
  totalRevenue          Decimal  @default(0) @db.Decimal(12, 2)
  
  // Performance metrics
  avgCourseRating       Decimal? @db.Decimal(3, 2)
  avgCompletionRate     Decimal? @db.Decimal(5, 2)
  
  // Last update
  lastUpdatedAt         DateTime @updatedAt
  createdAt             DateTime @default(now())

  // Relations
  instructor            User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@map("instructor_analytics")
}
